<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>股票記帳 PWA</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <style>
    :root { --bg:#f2f2f7; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb; --blue:#007aff; --red:#ff3b30; --green:#34c759; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif; background:var(--bg); color:var(--text);}
    header{ position:sticky; top:0; padding:12px 16px calc(12px + env(safe-area-inset-top)); background:rgba(242,242,247,.9); backdrop-filter:saturate(180%) blur(12px); border-bottom:1px solid var(--line); }
    h1{ margin:0; font-size:18px; font-weight:700;}
    .wrap{ padding:16px; max-width:760px; margin:0 auto; padding-bottom: calc(28px + env(safe-area-inset-bottom));}
    .seg{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; overflow:visible; }
    .seg button{ border:1px solid var(--line); background:var(--card); border-radius:999px; padding:8px 12px; font-size:14px; white-space:nowrap;}
    .seg button.active{ background:var(--blue); color:#fff; border-color:var(--blue);}
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin:12px 0; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{ width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; font-size:16px; background:#fff;}
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .btn{ border:0; border-radius:12px; padding:12px 14px; font-size:16px; background:var(--blue); color:#fff; }
    .btn.secondary{ background:#fff; color:var(--blue); border:1px solid var(--blue);}
    .btn.danger{ background:var(--red);}
    .hint{ font-size:12px; color:var(--muted); line-height:1.5;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    table{ width:100%; border-collapse:collapse; font-size:13px;}
    th,td{ padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top;}
    th{ color:var(--muted); font-weight:600;}
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line);}
    .pill.buy{ color:var(--green); border-color: rgba(52,199,89,.35); background: rgba(52,199,89,.08);}
    .pill.sell{ color:var(--red); border-color: rgba(255,59,48,.35); background: rgba(255,59,48,.08);}
    canvas{ width:100% !important; height:320px !important; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; }
    .split > *{ flex:1 1 260px; }
    a{ color:var(--blue); }
  
    .ledgerSource{ margin-top:6px; font-size:14px; color:var(--muted); }

    /* --- iOS date/time: keep native picker, avoid overflow/odd borders --- */
    .form-field{ margin-top:12px; }
    .ios-wrap{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      overflow:hidden;
      box-sizing:border-box;
    }
    .ios-native{
      width:100%;
      max-width:100%;
      min-width:0;
      display:block;
      height:52px;
      padding:12px 12px;
      font-size:16px;
      border:0 !important;
      border-radius:0 !important;
      outline:none;
      background:transparent;
      box-sizing:border-box;
      -webkit-appearance:auto;
      appearance:auto;
    }

  </style>
</head>
<body>
  <header>
    <h1>股票記帳（PWA）</h1>
        <div id="ledgerSource" class="ledgerSource">帳本來源：—</div>
<div class="seg" id="tabs">
      <button data-tab="add" class="active">新增交易</button>
      <button data-tab="query">查詢＋圖表</button>
      <button data-tab="holdings">持股總覽</button>
      <button data-tab="backup">備份/匯入</button>
      <button data-tab="about">說明</button>
    </div>
  </header>

  <div class="wrap">
    <!-- ADD -->
    <section id="tab-add">
      <div class="card">
        <div class="row">
          <div>
            <label>市場</label>
            <select id="f_market">
              <option value="TW">台股 (TW)</option>
              <option value="US">美股 (US)</option>
            </select>
          </div>
          <div>
            <label>買 / 賣</label>
            <select id="f_side">
              <option value="BUY">買進</option>
              <option value="SELL">賣出</option>
            </select>
          </div>
        </div>

        <label>股票代號</label>
        <input id="f_symbol" placeholder="例如：2330 或 AAPL" />

        <div class="form-field">
          <label for="f_date">日期</label>
          <div class="ios-wrap">
            <input id="f_date" type="date" class="ios-native" />
          </div>
        </div>

        <div class="form-field">
          <label for="f_time">時間</label>
          <div class="ios-wrap">
            <input id="f_time" type="time" class="ios-native" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>數量</label>
            <input id="f_qty" inputmode="decimal" placeholder="例如：100" />
          </div>
          <div>
            <label>價格</label>
            <input id="f_price" inputmode="decimal" placeholder="例如：586.5" />
          </div>
        </div>

        <label>手續費（可空白）</label>
        <input id="f_fee" inputmode="decimal" placeholder="例如：20" />

        <div class="btnrow">
          <button class="btn" id="btn_add">新增</button>
          <button class="btn secondary" id="btn_seed">填入範例</button>
        </div>
        <p class="hint">新增後會自動寫入本機資料（同一個網址、同一支手機一份資料）。</p>
      </div>
    </section>

    <!-- QUERY -->
    <section id="tab-query" hidden>
      <div class="card split">
        <div>
          <label>市場</label>
          <select id="q_market">
            <option value="TW">台股 (TW)</option>
            <option value="US">美股 (US)</option>
          </select>
        </div>
        <div>
          <label>股票代號</label>
          <input id="q_symbol" placeholder="例如：2330 或 AAPL" />
        </div>
        <div style="align-self:end">
          <button class="btn" id="btn_query">查詢</button>
        </div>
      </div>

      <div class="card" id="report_card" hidden>
        <div id="report_summary" style="font-size:15px; line-height:1.6;"></div>
        <div class="btnrow">
          <button class="btn secondary" id="btn_export_csv">匯出 CSV（這支股票）</button>
        </div>
      </div>

      <div class="card" id="table_card" hidden>
        <div class="hint" style="margin-bottom:8px;">交易序列（X 軸會顯示兩行：序號 / 庫存股數）</div>
        <table id="log_table">
          <thead>
            <tr>
              <th>#</th><th>日期</th><th>買/賣</th><th>數量</th><th>價格</th><th>交易後庫存</th><th>平均成本</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="chart_card" hidden>
        <canvas id="chart1"></canvas>
      </div>
    </section>

    <!-- HOLDINGS -->
    <section id="tab-holdings" hidden>
      <div class="card">
        <div class="btnrow">
          <button class="btn" id="btn_refresh_holdings">刷新</button>
        </div>
        <table id="holdings_table">
          <thead>
            <tr>
              <th>市場</th><th>代號</th><th>庫存</th><th>平均成本</th><th>已實現損益</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="tab-backup" hidden>
      <div class="card">
        <div class="btnrow">
          <button class="btn secondary" id="btn_export_json">匯出備份 JSON</button>
          <label class="btn secondary" for="file_import" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
            匯入 JSON
          </label>
          <input id="file_import" type="file" accept="application/json" hidden />
          <button class="btn danger" id="btn_reset">清空全部資料</button>
        </div>
        <p class="hint">
          建議：把匯出的 JSON 存到「檔案 App / iCloud Drive」，將來換手機也能匯入。<br>
          若你想要「全家人自動同步同一份資料」，需要加登入＋雲端資料庫（之後我可以再帶你升級）。
        </p>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="tab-about" hidden>
      <div class="card">
        <p style="margin-top:0; line-height:1.7;">
          這是一個「股票記帳」PWA 範例：用網頁做，但可加入主畫面像 App 一樣使用。<br>
          <span class="mono">資料預設存在本機（每支手機獨立）</span>，不會互相混在一起。
        </p>
        <ol style="line-height:1.7; padding-left:20px;">
          <li>用 Safari 打開網址</li>
          <li>分享 → 加入主畫面</li>
          <li>之後就像 App 一樣從桌面打開</li>
        </ol>
      </div>
    </section>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./app.js"></script>
  <script>
    (function(){
      const ua = navigator.userAgent || "";
      const isChrome = ua.includes("CriOS");
      const el = document.getElementById("ledgerSource");
      if (el) el.textContent = isChrome ? "帳本來源：Chrome 本機" : "帳本來源：Safari 本機";
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
